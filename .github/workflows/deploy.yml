name: Deploy to ECR

on:
 
  push:
    branches: [ main ]

permissions: 

  id-token: write
  contents: read

jobs:
  
  build:
    
    name: Build Image
    runs-on: ubuntu-latest

   
    steps:

    - name: Check out code
      uses: actions/checkout@v3

    - name: Validating Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 19
    - run: cd src && npm install
    - run: cd src && npm test 
      env:
       CI: true

    - name: Build and push Docker image
      env:
       DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
       DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
       docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
       docker build -t docker.io/ewertao/nodejs-hello:latest -f src/Dockerfile .
       docker push docker.io/ewertao/nodejs-hello:latest

  deploy:
    needs: build
    
    name: Deploy
    runs-on: ubuntu-latest
 
    steps:

       - name: Check out code
         uses: actions/checkout@v3
         
       - name: Configure AWS credentials
         uses: aws-actions/configure-aws-credentials@v2
         with:
           role-to-assume: arn:aws:iam::777156806021:role/githubactionprovider-role
           role-session-name: githubactionsprovider-role
           aws-region: eu-central-1
           
       - name: Deploy K8s 
         uses: aws-actions/run-command@v1
         with:
           comment: Pull Docker image on EC2 instance
           document-name: AWS-RunShellScript
           instance-id: i-040a92e9ab6973752
           parameters: |
             docker pull ewertao/nodejs-hello:latest
             export HOME=/
             kubectl apply -f /tmp/deployment.yml
           region: eu-central-1