name: Deploy to ECR

on:
 
  push:
    branches: [ main ]

permissions: 

  id-token: write
  contents: read

jobs:
  
  build:
    
    name: Build Image
    runs-on: ubuntu-latest

   
    steps:

    - name: Check out code
      uses: actions/checkout@v3

    - name: Validating Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 19
    - run: cd src && npm install
    - run: cd src && npm test 
      env:
       CI: true

    - name: Build and push Docker image
      env:
       DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
       DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
       docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
       docker build -t docker.io/ewertao/nodejs-hello:latest ./Dockerfile
       docker push docker.io/ewertao/nodejs-hello:latest

  deploy:
    needs: build
    
    name: Deploy
    runs-on: ubuntu-latest
 
    steps:

       - name: Check out code
         uses: actions/checkout@v3
         
       - name: Configure AWS credentials
         uses: aws-actions/configure-aws-credentials@v2
         with:
           role-to-assume: arn:aws:iam::777156806021:role/githubactionprovider-role
           role-session-name: githubactionsprovider-role
           aws-region: eu-central-1
           
       - name: Deploy K8s 
         env:
           IMAGE_TAG: ${{ github.sha }}
           INSTANCE_ID: i-0b042f3902b02f602
         run: |
           aws ssm send-command --document-name "AWS-RunShellScript" --instance-ids $INSTANCE_ID --parameters '{"commands": ["export HOME=/", "kubectl apply -f /tmp/deployment.yml"]}' 